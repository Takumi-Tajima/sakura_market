.mt-3
  .row
    .col-8.mx-auto
      %h1.fs-2.mb-4 注文確認
      = render 'layouts/shared/error_messages', resource: @order
      .card.mb-4
        .card-header
          %h5.mb-0 注文商品
        .card-body
          - @cart_items.each do |item|
            .row.py-3.border-bottom
              .col-3
                %h5= item.food.name
                %p.text-muted= item.food.description
              .col-1
                %p.mb-0= CartItem.human_attribute_name(:quantity)
                %p.fw-bold= item.quantity
              .col-2
                %p.mb-0= Food.human_attribute_name(:price)
                %p.fw-bold= number_to_currency(item.food.price_with_tax)
              .col-2
                %p.mb-0 小計
                %p.fw-bold= number_to_currency(item.total_price_with_tax)


      .card.mb-4
        .card-header.d-flex.justify-content-between
          %h5.mb-0 配送先情報
          -# ユーザー情報の変更リンク
          = link_to '登録住所の変更', root_path
        .card-body
          .row.mb-2
            .col-3
              %p.mb-0 お名前
            .col-9
              %p.fw-bold= current_user.name
          .row.mb-3
            .col-3
              %p.mb-0 住所
            .col-9
              %p.fw-bold= current_user.address

      = simple_form_for([:users, @order]) do |f|
        .card.mb-4
          .card-header
            %h5.mb-0 配送日・時間帯指定
          .card-body
            %p.text-muted.mb-3 ご注文日から3日後〜14日後の平日でご指定いただけます
            .row
              .col-md-6.mb-3
                = f.input :delivery_on,
                  as: :select,
                  collection: Order.available_delivery_dates.map { l(it) },
                  label: '配送日',
                  prompt: '配送日を選択してください',
                  input_html: { class: 'form-select' },
                  required: true
              .col-md-6.mb-3
                = f.input :delivery_time_slot,
                  as: :select,
                  collection: Order::DELIVERY_TIME_SLOTS.map { |slot| [slot, slot] },
                  label: '配送時間帯',
                  prompt: '時間帯を選択してください',
                  input_html: { class: 'form-select' },
                  required: true

        .card.mb-4
          .card-header
            %h5.mb-0 料金内訳
          .card-body
            .row.py-2
              .col-8
                %span 商品代金（税抜）
              .col-4.text-end
                %span= number_to_currency(current_cart.total_price)
            .row.py-2
              .col-8
                %span 送料（税抜）
              .col-4.text-end
                %span= number_to_currency(@order.calculate_shipping_fee(current_cart))
            .row.py-2
              .col-8
                %span 代引き手数料（税抜）
              .col-4.text-end
                %span= number_to_currency(@order.calculate_cash_on_delivery_fee(current_cart.total_price_with_tax))
            .row.py-2
              .col-8
                %span 商品税額（8%）
              .col-4.text-end
                %span= number_to_currency(current_cart.total_tax_amount)
            .row.py-2
              .col-8
                %span 送料・代引き手数料税額（10%）
              .col-4.text-end
                %span= number_to_currency((@order.calculate_shipping_fee(current_cart) + @order.calculate_cash_on_delivery_fee(current_cart.total_price_with_tax)) * 0.1)
            .row.py-2.border-top.pt-3
              .col-8
                %h5.mb-0 お支払い金額
              .col-4.text-end
                - total_amount = current_cart.total_price_with_tax + @order.calculate_shipping_fee(current_cart) + @order.calculate_cash_on_delivery_fee(current_cart.total_price_with_tax) + ((@order.calculate_shipping_fee(current_cart) + @order.calculate_cash_on_delivery_fee(current_cart.total_price_with_tax)) * 0.1).floor
                %h5.fw-bold.text-primary= number_to_currency(total_amount)

        .text-center.mt-4
          = f.submit '注文を確定する', class: 'btn btn-primary btn-lg px-5'
          = link_to 'カートに戻る', users_cart_path, class: 'btn btn-outline-secondary ms-3'
